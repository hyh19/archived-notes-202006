# [第 5 章 Nginx Web 服务应用](https://mrhuangyuhui.gitee.io/books/f7npHt_files/text/part0123.html)

## 5.1 Nginx 介绍

n/a

## 5.2 Nginx Web 服务

n/a

## 5.3 编译安装 Nginx

查看笔记 [Nginx Manual](https://gitee.com/mrhuangyuhui/notes/blob/master/manuals/nginx/nginx-manual.md)

## 5.4 Nginx 技术的深入剖析

n/a

## 5.5 Nginx 虚拟主机配置实战

### 5.5.1 虚拟主机的概念和类型介绍

所谓虚拟主机，在 Web 服务里就是一个独立的网站站点，这个站点对应独立的域名（也可能是 IP 或端口），具有独立的程序及资源目录，可以独立地对外提供服务供用户访问。

常见的虚拟主机类型有如下几种：

- 基于域名的虚拟主机
- 基于端口的虚拟主机
- 基于 IP 的虚拟主机

### 5.5.2 基于域名的虚拟主机配置实战

示例一：单个基于域名的虚拟主机配置

配置文件 `www.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
}
```

重载配置

```bash
# 检查配置文件的语法
nginx -t
# 重载配置
nginx -s reload
```

修改 `hosts` 文件

```bash
# Linux
echo "159.65.13.118 www.etiantian.org" >> /etc/hosts

# Mac
$ sudo vim /private/etc/hosts
159.65.13.118 www.etiantian.org
```

测试

```bash
$ curl www.etiantian.org
www.etiantian.org
```

示例二：多个基于域名的虚拟主机配置

`bbs.conf`

```bash
server {
    listen 80;
    server_name bbs.etiantian.org;
    location / {
        root /usr/share/nginx/html/bbs;
        index index.html index.htm;
    }
}
```

`blog.conf`

```bash
server {
    listen 80;
    server_name blog.etiantian.org;
    location / {
        root /usr/share/nginx/html/blog;
        index index.html index.htm;
    }
}
```

```bash
echo "159.65.13.118 bbs.etiantian.org blog.etiantian.org" >> /etc/hosts
```

```bash
$ curl bbs.etiantian.org
bbs.etiantian.org

$ curl blog.etiantian.org
blog.etiantian.org
```

### 5.5.3 基于端口的虚拟主机配置实战

`www.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
}
```

`bbs.conf`

```bash
server {
    listen 81;
    server_name bbs.etiantian.org;
    location / {
        root /usr/share/nginx/html/bbs;
        index index.html index.htm;
    }
}
```

`blog.conf`

```bash
server {
    listen 82;
    server_name blog.etiantian.org;
    location / {
        root /usr/share/nginx/html/blog;
        index index.html index.htm;
    }
}
```

```bash
$ curl www.etiantian.org:80
www.etiantian.org

$ curl bbs.etiantian.org:81
bbs.etiantian.org

$ curl blog.etiantian.org:82
blog.etiantian.org
```

### 5.5.4 基于 IP 的虚拟主机配置实战

添加虚拟 IP 地址

```bash
# 添加地址
ip a add 10.15.0.6/16 dev eth0

ip a add 10.15.0.7/16 dev eth0

# 检查添加结果
$ ip a | grep 10.15.0
    inet 10.15.0.5/16 brd 10.15.255.255 scope global eth0
    inet 10.15.0.6/16 scope global secondary eth0
    inet 10.15.0.7/16 scope global secondary eth0
```

`www.conf`

```bash
server {
    listen 10.15.0.5;
    server_name _;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
}
```

`bbs.conf`

```bash
server {
    listen 10.15.0.6;
    server_name _;
    location / {
        root /usr/share/nginx/html/bbs;
        index index.html index.htm;
    }
}
```

`blog.conf`

```bash
server {
    listen 10.15.0.7;
    server_name _;
    location / {
        root /usr/share/nginx/html/blog;
        index index.html index.htm;
    }
}
```

```bash
$ curl 10.15.0.5
www.etiantian.org

$ curl 10.15.0.6
bbs.etiantian.org

$ curl 10.15.0.7
blog.etiantian.org
```

### 5.5.5 Nginx 配置虚拟主机的步骤

[How nginx processes a request](http://nginx.org/en/docs/http/request_processing.html)

### 5.5.6 企业场景中重启 Nginx 后的检测策略

todo

## 5.6 Nginx 常用功能配置实战

### 5.6.1 规范优化 Nginx 配置文件

n/a

### 5.6.2 Nginx 虚拟主机的别名配置

`www.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
}
```

```bash
echo "159.65.15.233 www.etiantian.org etiantian.org" >> /etc/hosts
```

```bash
$ curl www.etiantian.org
www.etiantian.org

$ curl etiantian.org
www.etiantian.org
```

### 5.6.3 Nginx 状态信息功能实战

Nginx 软件的功能模块中有一个 `ngx_http_stub_status_module` 模块，这个模块的主要功能是记录 Nginx 的基本访问状态信息，让使用者了解 Nginx 的工作状态，例如连接数等信息。要使用状态模块，在编译 Nginx 时必须增加 `http_stub_status_module` 模块来支持。

检查 Nginx 的编译参数是否包含模块 `ngx_http_stub_status_module`

```bash
nginx -V | grep http_stub_status_module
```

`status1.conf`

```bash
server {
    listen 80;
    server_name status.etiantian.org;
    location / {
        stub_status on;
        access_log off;
    }
}
```

```bash
echo "159.65.15.233 status.etiantian.org" >> /etc/hosts
```

```bash
$ curl status.etiantian.org
Active connections: 1
server accepts handled requests
 28 28 28
Reading: 0 Writing: 1 Waiting: 0
```

只允许某些主机查看状态信息

`status2.conf`

```bash
server {
    listen 80;
    server_name status.etiantian.org;
    location / {
        stub_status on;
        access_log off;
        allow 159.65.15.233;
        deny all;
    }
}
```

Refs

- [stub_status](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status)
- [ngx_http_stub_status_module](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html)

### 5.6.4 为 Nginx 增加错误日志（`error_log`）配置

[error_log](http://nginx.org/en/docs/ngx_core_module.html#error_log)

## 5.7 Nginx 访问日志（`access_log`）

### 5.7.1 Nginx 访问日志介绍

[ngx_http_log_module](http://nginx.org/en/docs/http/ngx_http_log_module.html)

### 5.7.2 访问日志参数

- [access_log (ngx_http_log_module)](http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log)
- [log_format (ngx_http_log_module)](http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format)

### 5.7.3 访问日志配置说明

n/a

### 5.7.4 访问日志配置实战

`www1.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
    access_log /var/log/nginx/access_www.log main;
}
```

```bash
$ cat /var/log/nginx/access_www.log
159.65.132.169 - - [15/Feb/2018:14:24:56 +0000] "GET / HTTP/1.1" 200 18 "-" "curl/7.29.0" "-"
85.203.47.58 - - [15/Feb/2018:14:26:59 +0000] "GET / HTTP/1.1" 200 18 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/602.3.12 (KHTML, like Gecko) Version/10.0.2 Safari/602.3.12" "-"
```

可以在记录日志参数中加上 `buffer` 和 `flush` 选项，这样可在高并发场景下提升网站访问性能。

`www2.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
    access_log /var/log/nginx/access_www.log main gzip buffer=32k flush=5s;
}
```

### 5.7.5 Nginx 访问日志轮询切割

n/a

## 5.8 Nginx location

[location](http://nginx.org/en/docs/http/ngx_http_core_module.html#location)

## [5.9 Nginx `rewrite`](https://mrhuangyuhui.gitee.io/books/f7npHt_files/text/part0157.html)

### 5.9.1 什么是 Nginx `rewrite`

Nginx `rewrite` 的主要功能是实现 URL 地址重写

### 5.9.2 Nginx `rewrite` 语法

![image](https://mrhuangyuhui.gitee.io/books/f7npHt_files/images/00189.jpeg)

- `last` 和 `break` 用来实现 URL 重写，浏览器地址栏的 URL 地址不变，但在服务器端访问的程序及路径发生了变化；
- `redirect` 和 `permanent` 用来实现 URL 跳转，浏览器地址栏会显示跳转后的 URL 地址。

Refs

[rewrite](http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite)

### 5.9.3 Nginx `rewrite` 的企业应用场景

n/a

### 5.9.4 Nginx `rewrite` 301 跳转

`/etc/nginx/conf.d/www.conf`

```nginx
# nginx/1.12.2
server {
    listen 80;
    server_name etiantian.org;
    rewrite ^/(.*) http://www.etiantian.org/$1 permanent;
}

server {
    listen 80;
    server_name www.etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
    access_log /var/log/nginx/access_www.log main gzip buffer=32k flush=5s;
}
```

### 5.9.5 实现不同域名的 URL 跳转

示例一：实现访问 <http://blog.etiantian.org> 时跳转到 <http://www.etiantian.org/blog/oldboy.html>

`/etc/nginx/conf.d/blog.conf`

```nginx
# nginx/1.12.2
server {
    listen 80;
    server_name blog.etiantian.org;
    location / {
        root /usr/share/nginx/html/blog;
        index index.html index.htm;
    }
    if ($http_host ~* "^(.*)\.etiantian\.org$") {
        set $domain $1;
        rewrite ^(.*) http://www.etiantian.org/$domain/oldboy.html break;
    }
}
```

`/etc/nginx/conf.d/www.conf`

```nginx
# nginx/1.12.2
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
    access_log /var/log/nginx/access_www.log main gzip buffer=32k flush=5s;
}
```

测试

```bash
mkdir -p /usr/share/nginx/html/blog/
echo "blog.etiantian.org" > /usr/share/nginx/html/blog/index.html

mkdir -p /usr/share/nginx/html/www/
echo "www.etiantian.org" > /usr/share/nginx/html/www/index.html

mkdir -p /usr/share/nginx/html/www/blog/
echo "oldboy.html" > /usr/share/nginx/html/www/blog/oldboy.html
```

示例二：实现访问 <http://etiantian.org/bbs> 时跳转到 <http://bbs.etiantian.org>

`/etc/nginx/conf.d/www.conf`

```bash
# nginx/1.12.2
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
    }
    rewrite ^(.*)/bbs/ http://bbs.etiantian.org break;
    access_log /var/log/nginx/access_www.log main gzip buffer=32k flush=5s;
}
```

`/etc/nginx/conf.d/bbs.conf`

```bash
# nginx/1.12.2
server {
    listen 80;
    server_name bbs.etiantian.org;
    location / {
        root /usr/share/nginx/html/bbs;
        index index.html index.htm;
    }
}
```

测试

```bash
mkdir -p /usr/share/nginx/html/bbs/
echo "bbs.etiantian.org" > /usr/share/nginx/html/bbs/index.html

mkdir -p /usr/share/nginx/html/www/
echo "www.etiantian.org" > /usr/share/nginx/html/www/index.html

mkdir -p /usr/share/nginx/html/www/bbs/
echo "www/bbs/index.html" > /usr/share/nginx/html/www/bbs/index.html
```

> 建议：
>
> - 在根 `location`（即 `location / {}`）或 `server {}` 标签中编写 `rewrite` 规则，建议使用 `last` 标记；
> - 在普通的 `location`（例如 `location /oldboy/ {}` 或 `if {}`）中编写 `rewrite` 规则，则建议使用 `break` 标记。

## 5.10 Nginx 访问认证

`www.conf`

```bash
server {
    listen 80;
    server_name www.etiantian.org etiantian.org;
    location / {
        root /usr/share/nginx/html/www;
        index index.html index.htm;
        auth_basic "oldboy training";
        auth_basic_user_file /etc/nginx/htpasswd;
    }
    access_log /var/log/nginx/access_www.log main gzip buffer=32k flush=5s;
}
```

设置账号和密码

```bash
yum install httpd -y
htpasswd -bc /etc/nginx/htpasswd oldboy 123456
chmod 400 /etc/nginx/htpasswd
chown nginx /etc/nginx/htpasswd
```

## 5.11 Nginx 相关问题的解答

n/a
