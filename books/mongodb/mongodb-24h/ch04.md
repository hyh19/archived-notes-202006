# [第 4 章 配置用户账户和访问控制](https://mrhuangyuhui.gitee.io/books/rTSFcF_files/text/part0011.html)

## 4.1 理解 admin 数据库

用户账户在 admin 数据库中进行管理

## 4.2 管理用户账户

### 4.2.1 创建用户账户

```bash
# 在数据库 test 中创建一个基本的管理员账户
> use test
> db.addUser({ user: "testUser", pwd: "test", roles: ["readWrite", "dbAdmin"] })
# 将上面的账户添加到数据库 newDB 中，拥有只读权限，同时，对数据库 testDB2 拥有读写权限。
> use newDB
> db.addUser({ user: "testUser", userSource: "test", roles: ["read"], otherDBRoles: { testDB2: ["readWrite"] } })
```

```js
mongo = new Mongo("localhost")
db = mongo.getDB("test")
db.addUser({
    user: "testAdmin",
    pwd: "test",
    roles: ["dbAdmin"]
})
db.addUser({
    user: "testWriter",
    pwd: "test",
    roles: ["readWrite"]
})
db.addUser({
    user: "testReader",
    pwd: "test",
    roles: ["read"]
})
db = mongo.getDB("admin")
db.addUser({
    user: "testUser",
    userSource: "test",
    roles: ["read"],
    otherDBRoles: { test: ["readWrite"] }
})
```

API

- [db.addUser()](https://docs.mongodb.com/v2.4/reference/method/db.addUser/index.html)

### 4.2.2 列出用户

```bash
> use admin
> show users
```

```js
mongo = new Mongo("localhost")
db = mongo.getDB("test")
// 在每个数据库中，用户账户都存储在集合 db.system.users 中。
cur = db.system.users.find()
printjson(cur.toArray())
```

### 4.2.3 删除用户

```bash
> use testDB
> db.removeUser("testUser")
```

```js
mongo = new Mongo("localhost")
db = mongo.getDB("test")
db.removeUser("testReader")
cur = db.system.users.find()
printjson(cur.toArray())
```

API

- [db.removeUser()](https://docs.mongodb.com/v2.4/reference/method/db.removeUser/)

## 4.3 配置访问控制

### 4.3.1 创建用户管理员账户

```bash
> use admin
> db.addUser({ user: "useradmin", pwd: "test", roles: ["userAdminAnyDatabase"] })
```

### 4.3.2 启用身份验证

```bash
# -auth 服务器开启身份验证
mongod --dbpath ~/mongodb/data/db -auth
```

```bash
$ mongo --host 127.0.0.1:27017
> use admin
# 身份验证
> db.auth("useradmin", "test")
```

### 4.3.3 创建数据库管理员账户

```bash
> use admin
# 创建数据库管理员账户
> db.addUser({ user: "dbadmin", pwd: "test", roles: ["readWriteAnyDatabase", "dbAdminAnyDatabase", "clusterAdmin"] })
# 验证创建结果
> use admin
> db.auth("dbadmin", "test")
```

```js
mongo = new Mongo("localhost")
db = mongo.getDB("admin")
db.addUser({
    user: "dbadmin",
    pwd: "test",
    roles: ["readWriteAnyDatabase",
        "dbAdminAnyDatabase",
        "clusterAdmin"]
})
db.addUser({
    user: "useradmin",
    pwd: "test",
    roles: ["userAdminAnyDatabase"]
})
```