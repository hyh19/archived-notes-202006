# [第七章、Linux 磁碟與檔案系統管理](http://linux.vbird.org/linux_basic/0230filesystem.php)

关键词：inode、block

分割表：MBR、GPT

CentOS 7 默认使用 xfs 做文件系统

## 7.1 認識 Linux 檔案系統

Linux 最傳統的磁碟檔案系統 (filesystem) 使用的是 EXT2

### 7.1.1 磁碟組成與分割的複習

整顆磁碟的組成主要有：

- 圓形的磁碟盤(主要記錄資料的部分)；
- 機械手臂，與在機械手臂上的磁碟讀取頭(可讀寫磁碟盤上的資料)；
- 主軸馬達，可以轉動磁碟盤，讓機械手臂的讀取頭在磁碟盤上讀寫資料。

磁碟盤的物理組成：

- 磁區(Sector)為最小的物理儲存單位，且依據磁碟設計的不同，目前主要有 512bytes 與 4K 兩種格式；
- 將磁區組成一個圓，那就是磁柱(Cylinder)；
- 早期的分割主要以磁柱為最小分割單位，現在的分割通常使用磁區為最小分割單位(每個磁區都有其號碼喔，就好像座位一樣)；
- 磁碟分割表主要有兩種格式，一種是限制較多的 MBR 分割表，一種是較新且限制較少的 GPT 分割表。
- MBR 分割表中，第一個磁區最重要，裡面有：(1)主要開機區(Master boot record, MBR)及分割表(partition table)， 其中 MBR 佔有 446 bytes，而 partition table 則佔有 64 bytes。
- GPT 分割表除了分割數量擴充較多之外，支援的磁碟容量也可以超過 2TB。

至於磁碟的檔名部份，基本上，所有實體磁碟的檔名都已經被模擬成 /dev/sd[a-p] 的格式，第一顆磁碟檔名為 /dev/sda。 而分割槽的檔名若以第一顆磁碟為例，則為 /dev/sda[1-128] 。除了實體磁碟之外，虛擬機的磁碟通常為 /dev/vd[a-p] 的格式。

- `/dev/sd[a-p][1-128]`：為實體磁碟的磁碟檔名
- `/dev/vd[a-d][1-128]`：為虛擬磁碟的磁碟檔名

### 7.1.2 檔案系統特性

磁盘分区后要格式化成一定的文件系统格式后才能使用

Windows 的文件系统格式：FAT、NTFS

Linux 的文件系统格式：Ext2

过去：一个分区只能被格式化为一个文件系统

现在：一个分区可以被格式化为多个文件系统，多个分区也可以被合并为一个文件系统。

每個 inode 與 block 都有編號，至於這三個資料的意義可以簡略說明如下：

- superblock：記錄此 filesystem 的整體資訊，包括inode/block的總量、使用量、剩餘量， 以及檔案系統的格式與相關資訊等；
- inode：記錄檔案的屬性，一個檔案佔用一個inode，同時記錄此檔案的資料所在的 block 號碼；
- block：實際記錄檔案的內容，若檔案太大時，會佔用多個 block 。

### 7.1.3 Linux 的 EXT2 檔案系統(inode)

檔案系統一開始就將 inode 與 block 規劃好了，除非重新格式化(或者利用 resize2fs 等指令變更檔案系統大小)，否則 inode 與 block 固定後就不再變動。

Ext2 檔案系統在格式化的時候基本上是區分為多個區塊群組 (block group) 的，每個區塊群組都有獨立的 inode/block/superblock 系統。

檔案系統最前面有一個開機磁區(boot sector)，這個開機磁區可以安裝開機管理程式。

---

data block (資料區塊)

在 Ext2 檔案系統中所支援的 block 大小有 1K, 2K 及 4K 三種。由於 block 大小的差異，會導致該檔案系統能夠支援的最大磁碟容量與最大單一檔案容量並不相同。

Block 大小 | 1KB | 2KB | 4KB
--- | --- | --- | ---
最大單一檔案限制 | 16GB | 256GB | 2TB
最大檔案系統總容量 | 2TB | 8TB | 16TB

其他限制如下：

- 原則上，block 的大小與數量在格式化完就不能夠再改變了(除非重新格式化)；
- 每個 block 內最多只能夠放置一個檔案的資料；
- 承上，如果檔案大於 block 的大小，則一個檔案會佔用多個 block 數量；
- 承上，若檔案小於 block ，則該 block 的剩餘容量就不能夠再被使用了(磁碟空間會浪費)。

---

inode table (inode 表格)

inode 的內容在記錄檔案的屬性以及該檔案實際資料是放置在哪幾號 block 內！ 基本上，inode 記錄的檔案資料至少有底下這些：

- 該檔案的存取模式(read/write/excute)；
- 該檔案的擁有者與群組(owner/group)；
- 該檔案的容量；
- 該檔案建立或狀態改變的時間(ctime)；
- 最近一次的讀取時間(atime)；
- 最近修改的時間(mtime)；
- 定義檔案特性的旗標(flag)，如 SetUID...；
- 該檔案真正內容的指向 (pointer)；

inode 的數量與大小也是在格式化時就已經固定了，除此之外 inode 還有些什麼特色呢？

- 每個 inode 大小均固定為 128 bytes (新的 ext4 與 xfs 可設定到 256 bytes)；
- 每個檔案都僅會佔用一個 inode 而已；
- 承上，因此檔案系統能夠建立的檔案數量與 inode 的數量有關；
- 系統讀取檔案時需要先找到 inode，並分析 inode 所記錄的權限與使用者是否符合，若符合才能夠開始實際讀取 block 的內容。

系統將 inode 記錄 block 號碼的區域定義為12個直接，一個間接, 一個雙間接與一個三間接記錄區。所謂的間接就是再拿一個 block 來當作記錄 block 號碼的記錄區，如果檔案太大時， 就會使用間接的 block 來記錄號碼。